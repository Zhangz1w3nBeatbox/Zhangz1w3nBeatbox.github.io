## ä¸€.æ ¡å›­è§†é¢‘ç¤¾åŒºäº¤å‹å¹³å°ğŸ’•

### 1ï¸âƒ£. é¡¹ç›®é‡‡ç”¨ä¸»æµçš„Springboot+Vueæ¡†æ¶å¿«é€Ÿå¼€å‘ âš¡

### 2ï¸âƒ£. å¯¹æ…¢SQLè¿›è¡Œæ•°æ®åº“å­—æ®µå’ŒSQLè¯­å¥çš„ä¼˜åŒ– ä½¿å¾—æŸ¥è¯¢æ•ˆç‡å’Œç½‘ç«™è®¿é—®é€Ÿåº¦æé«˜30% ğŸš€

#### -å¦‚ä½•å®ç°?

> #### 1.è¡¨å­—æ®µï¼šintã€varcharã€timeã€æšä¸¾

> #### 2.SQLè¯­å¥ï¼šå‡å°‘è¡Œåˆ—æŸ¥è¯¢é‡ã€ 

> #### 3.è¡¨è®¾è®¡ï¼š

> #### 4.ä¸»é”®idè‡ªå¢

> #### 5. å¸¸ç”¨å­—æ®µä½¿ç”¨ç´¢å¼•

### 3ï¸âƒ£. ä½¿ç”¨WebSocketçš„é•¿è¿æ¥å…¨åŒå·¥é€šä¿¡å®ç°äº†å¼¹å¹•åŠŸèƒ½ ä¼˜åŒ–äº†é‡‡ç”¨çŸ­è¿æ¥æ—¶ç©ºè½®è¯¢é€ æˆçš„èµ„æºæµªè´¹é—®é¢˜ğŸ’¦  

#### -å¦‚ä½•å®ç°â“

> ###### 1.å®šä¹‰webSocketConfigé…ç½®ç±»

```java
@Configuration
public class webSocket {
    @Bean
    public ServerEndpointExporter serverEndpointExporter(){
            return  new ServerEndpointExporter();
    }
}
```

> ###### 2.é€šè¿‡å†™å¥½çš„webSocketServiceç±» ç±»ä¸­åŒ…å«ä¸€ä¸ªç”¨æˆ·åœ¨çº¿äººæ•°AtomicIntegerå’Œä¿å­˜åœ¨çº¿ç”¨æˆ·(webSocketService)çš„ConcurrentHashMap ä»¥åŠæ ¸å¿ƒçš„OnMessage()æ–¹æ³•å‘é€æ¶ˆæ¯æ–¹æ³• å’Œ é“¾æ¥æ–¹æ³•openConnection() [æŠŠè§‚çœ‹è¯¥è§†é¢‘çš„ç”¨æˆ·æ·»åŠ è‡³mapé›†åˆ]
 ```java
	@Component
    @ServerEndpoint("/imserver/{token}")
    public class webSocketService {

        private final Logger logger =  LoggerFactory.getLogger(this.getClass());

        public static final AtomicInteger ONLINE_COUNT = new AtomicInteger(0);

        //æ¯ä¸ªå®¢æˆ·ç«¯éƒ½éœ€è¦ä¸€ä¸ªwebSocketService-å› ä¸º
        public static final ConcurrentHashMap<String, com.zzw.service.webSocketService> WEBSOCKET_MAP = new ConcurrentHashMap();

        private Session session;

        private String sessionId;

        private Long userId;

        public Session getSession() {
            return session;
        }

        public String getSessionId() {
            return sessionId;
        }

        private static ApplicationContext Application_Context;

        public static void setApplicationContext(ApplicationContext applicationContext){
            com.zzw.service.webSocketService.Application_Context =applicationContext;
        }

        @OnOpen
        public void openConnection(Session session, @PathParam("token") String token){}

        //å‘é€ä¿¡æ¯æ–¹æ³•
        public void sendMessage(String message) throws Exception{}

        @OnClose//æ–­å¼€è¿æ¥
        public void closeConnection(Session session){}


        @OnMessage//å‘é€ä¿¡æ¯æ—¶å€™
        public void OnMessage(String message){}

        @OnError//å‘é€é”™è¯¯æ—¶å€™çš„æƒ…å†µ
        public void OnError(Throwable error){}

        //å®šæ—¶ä»»åŠ¡ - åœ¨ä¸»ç¨‹åºä¸­(Blibili_App.class)@EnableSchedulingè¦å¼€å¯
        @Scheduled(fixedRate = 5000)//fixedRate = 5000æ¯«ç§’------æ¯éš”5sæ‰§è¡Œä¸€æ¬¡å®šæ—¶ä»»åŠ¡

        public void noticeOnlineCount() throws Exception{}


    }
```

> ###### 3.ğŸ’¤å½“ç”¨æˆ·å‘é€å¼¹å¹•æ—¶ éå†mapé›†åˆä¸­çš„valueså¯¹è±¡ è·å¾—æ¯ä¸€webSocketServiceå¯¹è±¡ ä¹Ÿå°±æ˜¯è¿æ¥åˆ°æœåŠ¡å™¨çš„ç”¨æˆ· ç„¶åä½¿ç”¨`sentMessage()`æ–¹æ³• è¿›è¡Œç¾¤å‘å¼¹å¹•

> ###### 4.æŠŠå¼¹å¹•å­—ç¬¦è½¬å‡ºå¼¹å¹•å¯¹è±¡(DanMU) å¹¶ä¸”èµ‹å€¼ userId(tokenè·å–)ã€creatTimeã€videoId

> ###### 5.ğŸ’¤æŒä¹…åŒ–åˆ°æ•°æ®åº“å’ŒRedis

### 4ï¸âƒ£. ä½¿ç”¨RocketMQå’ŒRedis å¯¹å‘é€çš„å¼¹å¹•è¿›è¡Œå‰Šå³°å’Œç¼“å­˜ ç¼“è§£ç¾¤å‘å¼¹å¹•å’Œæ•°æ®åº“çš„å‹åŠ› ä¿è¯ç³»ç»Ÿçš„ç¨³å®šæ€§çš„åŒæ—¶å°†ç³»ç»ŸQPSæå‡äº†20å€(10/s-200/s) ğŸ’¥

#### -å¦‚ä½•å®ç°â“

> ###### ä¼˜åŒ–1.RocketMQå¯¹å‘é€çš„å¼¹å¹•è¿›è¡Œå‰Šå³°ç¼“è§£ç¾¤å‘å‹åŠ›
>

- ###### 	1.å½“ç”¨æˆ·å‘é€å¼¹å¹•æ—¶ éå†mapé›†åˆä¸­çš„valueså¯¹è±¡ è·å¾—æ¯ä¸€ä¸ªè¿æ¥åˆ°æœåŠ¡å™¨çš„ç”¨æˆ·


- ###### 	2.è·å–RokctMQConfigé…ç½®ç±»ä¸­çš„å¼¹å¹•ç”Ÿäº§è€…


- ###### 	3.æ„å»ºå‘é€çš„æ¶ˆæ¯å¯¹è±¡`Message`å¯¹è±¡ æŒ‡å®šæ¶ˆæ¯çš„ä¸»é¢˜ ä»¥åŠ å‘é€çš„æ¶ˆæ¯(`sessionId`å’Œ`å¼¹å¹•å†…å®¹`)


- ###### 	4.ä½¿ç”¨å®šä¹‰å¥½çš„RokctMQUtilsæ–¹æ³•ä¸­çš„å¼‚æ­¥å‘é€æ¶ˆæ¯æ–¹æ³•å‘é€æ¶ˆæ¯


```java
 //å‘é€æ–¹æ³•-å¼‚æ­¥
    public static  void asyncSendMsg(DefaultMQProducer producer, Message msg) throws Exception {

        //å‘é€2æ¬¡
        int count = 2;
		
        CountDownLatch2 countDownLatch = new CountDownLatch2(count);

        for(int i=0;i<count;i++){

            //å‘æ¶ˆæ¯
            producer.send(msg, new SendCallback() {

                @Override
                public void onSuccess(SendResult sendResult) {//æˆåŠŸå‘é€æ¶ˆæ¯
                    countDownLatch.countDown();
                    System.out.println(sendResult.getMsgId());
                }

                @Override
                public void onException(Throwable throwable) {//å‘é€æ¶ˆæ¯-å¼‚å¸¸
                    countDownLatch.countDown();
                    System.out.println("å‘é€æ¶ˆæ¯-å¼‚å¸¸:"+throwable);
                }
            });

        }
        countDownLatch.await(5, TimeUnit.SECONDS);
    };
```

- ######  	5.åœ¨RokctMQConfigé…ç½®ç±»ä¸­çš„ç”Ÿäº§å¼¹å¹•æ¶ˆè´¹è€…çš„æ–¹æ³•ä¸­ è®¾ç½®å¥½åˆ†ç»„å’Œä¸»é¢˜å åœ¨ç›‘å¬å™¨çš„`consumeMessage()`æ–¹æ³•ä¸­


- ###### 	6.è·å–ç”Ÿäº§è€…çš„æ¶ˆæ¯å¯¹è±¡


- ###### 	7.æŠŠæ¶ˆæ¯å¯¹è±¡é€šè¿‡`FastJsonObject`è½¬æˆå¼¹å¹•æ¶ˆæ¯å’ŒsessionId


- ###### 	8.é€šè¿‡SessionIdåœ¨Mapä¸­æ‰¾åˆ°å¯¹åº”çš„å®¢æˆ·ç«¯


- ###### 	9.å®¢æˆ·ç«¯ä½¿ç”¨`sentMessage`æ–¹æ³•ç¾¤å‘å¼¹å¹•


- ###### 	10.è¿”å›æ¶ˆè´¹æˆåŠŸ




> ###### ä¼˜åŒ–2.RocketMQå¯¹å‘é€çš„å¼¹å¹•çš„æŒä¹…åŒ–è¿›è¡Œå‰Šå³°ç¼“è§£æ•°æ®åº“çš„å‹åŠ›
>

- ###### 	 æŠŠå¼¹å¹•å†…å®¹è½¬æˆå¯¹åº”çš„å®ä½“ç±»(DanMu) å¹¶ä¸”èµ‹å€¼userIdã€åˆ›å»ºæ—¶é—´


- ######   ç”Ÿäº§è€…:

  ###### 		-è·å–RokctMQConfigé…ç½®ç±»ä¸­çš„ å¯¹åº”çš„æ¶ˆæ¯çš„ç”Ÿäº§è€…

  ###### 		-æ„å»ºå‘é€çš„æ¶ˆæ¯å¯¹è±¡`Message`å¯¹è±¡ æŒ‡å®šæ¶ˆæ¯çš„`ä¸»é¢˜` ä»¥åŠ å‘é€çš„æ¶ˆæ¯-`å¼¹å¹•å¯¹è±¡`

  ###### 		-ä½¿ç”¨å®šä¹‰å¥½çš„RokctMQUtilsæ–¹æ³•ä¸­çš„å¼‚æ­¥å‘é€æ¶ˆæ¯æ–¹æ³•å‘é€æ¶ˆæ¯-å‰Šå³°ä½¿ç”¨`countDownLatch`é™åˆ¶å‘é€æ•°æ®çš„æ¬¡æ•° æ¯æ¬¡é™åˆ¶å‘é€å¤šå°‘æ¬¡ åšé™æµ è“„æ´ªå’Œæ³„æ´ª



- ###### æ¶ˆè´¹è€…:

  ###### 	åœ¨RokctMQConfigé…ç½®ç±»ä¸­çš„ç”Ÿäº§å¼¹å¹•æ¶ˆè´¹è€…çš„æ–¹æ³•ä¸­ è®¾ç½®å¥½åˆ†ç»„å’Œä¸»é¢˜å åœ¨ç›‘å¬å™¨çš„`consumeMessage()`æ–¹æ³•ä¸­

  ######     -è·å–ç”Ÿäº§è€…å‘é€æ¶ˆæ¯å­—ç¬¦ä¸²

  ###### 	-æŠŠå­—ç¬¦ä¸²è½¬æˆå¼¹å¹•å¯¹è±¡

  ###### 	-æŠŠå¼¹å¹•å¯¹è±¡å¼‚æ­¥æŒä¹…åŒ–åˆ°æ•°æ®åº“

  ###### 	-æ¶ˆè´¹æˆåŠŸ

> ###### ä¼˜åŒ–3.redisç¼“å­˜å¼¹å¹•-ç¼“è§£æ•°æ®åº“è¯·æ±‚çš„å‹åŠ›

- ###### 	-å¼¹å¹•æŒä¹…åŒ–åˆ°æ•°æ®åº“åå†å¯¹Redisè¿›è¡Œç¼“å­˜

  ###### 		-`Key`:`"danmu-"+videoId`

  ######    	-`Value`:`å‘é€çš„å¼¹å¹•`

##### æ•°æ®å’Œç¼“å­˜çš„ä¸€ç³»åˆ—é—®é¢˜â—

###### 	â‘ æ•°æ®è®¿é—®å…ˆå:

â€‹		å…ˆè®¿é—®ç¼“å­˜å†è®¿é—®æ•°æ®åº“

###### â‘¡ç¼“å­˜å’Œæ•°æ®åº“æ•°æ®ä¸€è‡´æ€§çš„ä¿è¯

â€‹		ç¼“å­˜æœ‰-ç›´æ¥å–  ç¼“å­˜æ²¡æœ‰è¯·æ±‚æ•°æ®åº“ ç„¶åæŠŠæ•°æ®åŠæ—¶ç”¨å®šæ—¶ä»»åŠ¡æ›´æ–°å›ç¼“å­˜(å…ˆåˆ é™¤keyå†æ·»åŠ )

â€‹	**ç¼“å­˜é›ªå´©**:keyå¤§é¢ç§¯åŒæ—¶å¤±æ•ˆ-----------è¿‡æœŸæ—¶é—´è®¾ç½®ä¸ºéšæœºã€çƒ­ç‚¹æ•°æ®æ°¸ä¸è¿‡æœŸã€

â€‹	**ç¼“å­˜ç©¿é€**:å¯¹ä¸€ä¸ªæ ¹æœ¬ä¸å­˜åœ¨çš„æ•°æ®è¿›è¡Œå¤§é‡è¯·æ±‚-æ¯”å¦‚age=0 ç¼“å­˜æ‰¾ä¸åˆ° å°±ç›´æ¥è¯·æ±‚æ•°æ®åº“ - å¯¹æ•°æ®åº“é€ æˆå·¨å¤§å‹åŠ›---------------å‰ç«¯å…ˆåšæ ¡éªŒã€å¸ƒéš†è¿‡æ»¤å™¨( å°†æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„æ•°æ®å“ˆå¸Œåˆ°ä¸€ä¸ªè¶³å¤Ÿå¤§çš„bitmapä¸­ï¼Œä¸€ä¸ªä¸€å®šä¸å­˜åœ¨çš„æ•°æ®ä¼šè¢« è¿™ä¸ªbitmapæ‹¦æˆªæ‰ï¼Œä»è€Œé¿å…äº†å¯¹åº•å±‚å­˜å‚¨ç³»ç»Ÿçš„æŸ¥è¯¢å‹åŠ› )ã€è®¾ç½®key null æŠŠä¸å­˜åœ¨çš„æ•°æ®ä»»ç„¶å­˜åœ¨redis åªä¸è¿‡å€¼ä¸ºnull  ä½†å®ƒçš„è¿‡æœŸæ—¶é—´ä¼šå¾ˆçŸ­ï¼Œæœ€é•¿ä¸è¶…è¿‡äº”åˆ†é’Ÿã€‚ 

â€‹	

â€‹	**ç¼“å­˜å‡»ç©¿**:å¤§é‡è¯·æ±‚ä¸€ä¸ªä»¥åŠå¤±æ•ˆçš„ç¼“å­˜çš„keyé€ æˆæ•°æ®åº“å®•æœº-------**åŠ äº’æ–¥é”**( setnx())( ç®€å•åœ°æ¥è¯´ï¼Œå°±æ˜¯åœ¨ç¼“å­˜å¤±æ•ˆçš„æ—¶å€™ï¼ˆè¯·æ±‚çš„æ•°æ®çš„valueä¸ºç©º)  å¾€ redis ç”¨ setnx è®¾ç½®ä¸€ä¸ª keyï¼Œæ¥è¡¨ç¤ºè¿™æ˜¯ä¸€æŠŠé” è®¾ç½®æˆåŠŸå  ç„¶åå»è¯»å–æ•°æ®åº“è¯»æ•°æ®ï¼Œå¹¶ä¸”å†™å› redis  åœ¨æ­¤æœŸé—´  å…¶ä»–çš„çº¿ç¨‹ï¼Œåˆ™ sleep ä¸€å°ä¼šï¼Œç„¶åå†å»è®¿é—®æˆ‘ä»¬çš„ redis



### 5ï¸âƒ£. ä½¿ç”¨Mahoutçš„ååŒè¿‡æ»¤ç®—æ³• é€šè¿‡åˆ†æç”¨æˆ·è§‚çœ‹è§†é¢‘çš„ä¹ æƒ¯ å®ç°äº†å¯¹ç›¸ä¼¼ç”¨æˆ·æ¨èå¯èƒ½å–œæ¬¢çš„è§†é¢‘ ğŸ”‘

#### -å¦‚ä½•å®ç°â“

> ###### 1.è·å–ç”¨æˆ·åå¥½æ•°æ®

###### 		-é€šè¿‡ä¸€ä¸ªç”¨æˆ·æ“ä½œè¡¨(idã€userIdã€videoIdã€operationType) é€šè¿‡ä¸åŒçš„æ“ä½œç±»å‹è·å–ä¸åŒçš„æƒå€¼ é€šè¿‡sqlè¯­å¥ç”Ÿæˆ ä¸€ä¸ªæ–°çš„è¡¨ å†å°è£…æˆä¸€ä¸ªuserPreferenceå¯¹è±¡(userIdã€videoIdã€value) çš„ é›†åˆè¿”å›

> ###### 2.åŒè¿‡ç”¨æˆ·åå¥½æ•°æ®ç”Ÿæˆå¯¹åº”æ•°æ®æ¨¡å‹

> ###### 3.è®¡ç®—ç”¨æˆ·ç›¸ä¼¼åº¦

> ###### 4.è®¡ç®—å‡ºç›¸ä¼¼ç”¨æˆ·

> ###### 5. è·å–æ¨èå™¨

> ###### 6.ç”Ÿæˆæ¨èçš„è§†é¢‘id

> ###### 7.æ‰¹é‡æŸ¥è¯¢è§†é¢‘idè·å–è§†é¢‘å¯¹è±¡é›†åˆ

> ###### 8.è¿”å›è§†é¢‘å¯¹è±¡é›†åˆ

### 6ï¸âƒ£. ä¸ºæé«˜æ•°æ®çš„æŸ¥è¯¢å“åº”é€Ÿåº¦é‡‡ç”¨ElasticSearchè¿›è¡Œä¼˜åŒ– QPSä»8/sæå‡è‡³10/s æå‡ äº†çº¦120% ğŸ”¥

#### -å¦‚ä½•å®ç°â“

> ###### 1.è¾“å…¥å…³é”®å­— èµ°ç›¸å…³è¯·æ±‚

> ###### 2.æŠŠå†Entityå®šä¹‰çš„indexæ”¾å…¥ä¸€ä¸ªæ•°æ® æ”¾å…¥SearchRequestå¯¹è±¡

> ###### 3.ç”ŸæˆSearchSourceå¯¹è±¡

> ###### 4.Query.builderä¸­è·å–ä¸€ä¸ªmutiMatchQueryå¯¹è±¡ è¾“å…¥æœç´¢å…³é”®å­—å’ŒEntityå®šä¹‰æŸ¥è¯¢çš„å­—æ®µ

> ###### 5. SearchSourceè¾“å…¥mutiMatchQuery-å¼€å§‹æ‰§è¡ŒæŸ¥è¯¢

> ###### 6.SearchRequestè°ƒç”¨Sourceæ–¹æ³•æ‰§è¡ŒSearchSource

> ###### 7.ä»å®šä¹‰å¥½çš„restHighLevelClient.searchä¸­è·å–SearchResponseå¯¹è±¡

> ###### 8.æ„å»ºè¿”å›ç»“æœé›†åˆList<Map<String,Object>> list

> ###### 9.éå†SearchResponse.getHits() æŠŠæ¯ä¸€ä¸ªè·å¾—çš„hitè½¬æ¢æˆmapé›†åˆ å­˜å…¥listé›†åˆ

> ###### 10.è¿”å›listé›†åˆ

## 					äºŒ.åŸºäºäººå·¥æ™ºèƒ½çš„æ ¡å›­åŠ©æ‰‹ğŸ’»

### 1ï¸âƒ£.  ç‹¬ç«‹å¼€å‘åŸºäºSpringbootå’ŒVueçš„é•¿ç†æ ¡å›­åŠ©æ‰‹ï¼Œé‡‡ç”¨ä¸»æµçš„å‰åç«¯åˆ†ç¦»æ¶æ„  âš¡

### 2ï¸âƒ£.  ä¸ºé€‚åº”ç³»ç»Ÿç‰¹æ€§ åŠ å¿«è¿­ä»£é€Ÿåº¦ åç«¯ä»SSMæ¡†æ¶æ”¹è¿›è‡³Springbootæ¡†æ¶ é…åˆMyBatisæ¡†æ¶å’ŒRedisç¼“å­˜å®ç°äº†æ•°æ®å‰åä¸€ ä½“çš„é›†ä¸­å¼é…ç½®ä¼˜åŒ– æé«˜äº†æ¥è¿‘1å€çš„å¼€å‘æ•ˆç‡ ğŸš€

### 3ï¸âƒ£.  â­ä½¿ç”¨ JWT ç”ŸæˆAccess tokenå’Œ Refresh token å®ç°åŒä»¤ç‰ŒéªŒè¯æœºåˆ¶ å®Œæˆäº†ç™»å½•æ—¶ç”¨æˆ·çš„èº«ä»½è®¤è¯ ä¼˜åŒ–äº†å•ä»¤ç‰Œæƒ…å†µä¸‹ å› Tokenè¿‡æœŸé€ æˆçš„æ½œåœ¨å®‰å…¨å’Œç”¨æˆ·ä½“éªŒæ„Ÿä¸ä½³é—®é¢˜  â“

#### -å¦‚ä½•å®ç°â“

###### 				ç™»å½•ï¼š

> #### 1.ç™»å½•æˆåŠŸåç”Ÿæˆé€šè¿‡JWTUtilsç”ŸæˆåŒtoken ç”ŸæˆAccess tokenå’Œ Refresh token

> #### 2.æŠŠ Refresh tokenæŒä¹…åŒ–åˆ°æ•°æ®åº“(å…ˆåˆ é™¤å†æ·»åŠ )-(idã€userIdã€refreshToken)

> #### 3.è¿”å›åŒä»¤ç‰Œ-Map (ç”Ÿæˆçš„Access tokenå’Œ Refresh token )

###### 			é€€å‡ºç™»å½•ï¼š

> #### 1.è·å–å¯¹è±¡å¤´ä¸­çš„ Refresh token å€¼

> #### 2.åˆ é™¤æ•°æ®åº“ä¸­å¯¹åº”çš„Refresh token å€¼

###### 			åˆ·æ–°Access tokenæ—¶æœºï¼š

> #### 1.è·å–å¯¹è±¡å¤´ä¸­çš„ Refresh token å€¼

> #### 2.è·å–æ•°æ®åº“ä¸­Refresh token å¯¹åº”userId

> #### 3.userIdæ²¡æœ‰åˆ™tokenè¿‡æœŸå¼‚å¸¸ æœ‰åˆ™å†é€šè¿‡JWTUtilsç”ŸæˆAcessToken

> #### 4.è¿”å›AcessToken

##### -ä¼˜åŒ–ç‚¹â“

> ###### 	1.è¿‡æœŸæ—¶é—´å¤ªé•¿ é€€å‡ºç™»å½• è¿˜å¯ä»¥è·å–æœ¬åœ°çš„token å»è¿›è¡Œæ“ä½œ-å®‰å…¨é—®é¢˜

> ###### 	2.-ç™»å½•çŠ¶æ€AcessTokenè¿‡æœŸæ—¶æ— æ„Ÿåˆ·æ–°ä»¤ç‰Œ-ä½“éªŒæ„Ÿé—®é¢˜

> ###### 	3.-èŠ‚çœæœåŠ¡å™¨èµ„æº-ä¸é€šè¿‡sessionåˆ¤æ–­ç”¨æˆ·ä¿¡æ¯

### 4ï¸âƒ£.  â­æŠŠå¸¸ç”¨åˆ°çš„çƒ­ç‚¹æ•°æ®ç¼“å­˜åœ¨Redis åˆ©ç”¨å…¶äºå†…å­˜çš„é«˜é€Ÿè¯»å–æ•°æ®çš„ç‰¹æ€§ é™ä½äº†æ•°æ®åº“è®¿é—®å‹åŠ›  ğŸ”‘

### 5ï¸âƒ£.   æ¥å…¥ç¬¬ä¸‰æ–¹äººè„¸è¯†åˆ«SDK å¯¹ç”¨æˆ·çš„èº«ä»½è¿›è¡ŒéªŒè¯ è¿›ä¸€æ­¥ä¿è¯äº†ç”¨æˆ·ä¿¡æ¯å®‰å…¨å¹¶ä¸”æå‡äº†ç”¨æˆ·ä½¿ç”¨ä½“éªŒ ğŸ”¥

### 6ï¸âƒ£. â­ä½¿ç”¨RocketMQå®ç°åŠ¨æ€å†…å®¹çš„æ¨é€ğŸ’¥

> ###### 			1.ç”¨æˆ·è°ƒç”¨ç›¸å…³æ¥å£[Postè¯·æ±‚] å‘é€åŠ¨æ€æ—¶å€™ ç”Ÿæˆä¸€ä¸ªç”¨æˆ·åŠ¨æ€å¯¹è±¡`userMoment` **å¹¶ä¸”å­˜åˆ°æ•°æ®åº“ä¸­**
>

> ###### 2.é€šè¿‡Application Contextä¸Šä¸‹æ–‡çš„`get bean("userMomentProducter")`æ–¹æ³• è·å– åŠ¨æ€ç”Ÿäº§è€… 

###### 				-è¿™ä¸ªbeanæ˜¯ä¸€ä¸ªç”Ÿæˆç”Ÿäº§è€…çš„æ–¹æ³•  æ˜¯æå‰åœ¨RocketMQ Configrition ç±»ä¸­å®šä¹‰çš„ å¹¶ä¸”æ³¨å…¥çš„  å¹¶ä¸”ç”Ÿäº§è€…æå‰è®¾ç½®äº†æ¶ˆæ¯åˆ†ç»„

> ###### 3.å†å®šä¹‰ä¸€ä¸ªæ¶ˆæ¯å¯¹è±¡`(Message)` å¹¶ä¸”è®¾ç½® ä¹‹å‰å®šä¹‰ä¸»é¢˜ å’Œ è¦æ¨é€çš„å†…å®¹`(userMoment)`

> ###### 4.æœ€åé€šè¿‡è°ƒç”¨ æå‰å†™å¥½çš„RocketMQUtilsçš„å‘é€æ¶ˆæ¯çš„æ–¹æ³• æŠŠå®šä¹‰å¥½çš„æ¶ˆæ¯ å‘é€åˆ°RocketMQ

###### 														-RocketMQUtilsç±»ä¸­ åŒ…å«äº†ä¸€ä¸ª åŒæ­¥å‘é€æ¶ˆæ¯æ–¹æ³•å’Œä¸€ä¸ªå¼‚æ­¥å‘é€æ¶ˆæ¯æ–¹æ³•

> ###### 5.å†åˆ°RocketMQ Configrition ç±»ä¸­çš„ ***æ¶ˆæ¯æ¶ˆè´¹è€…***  ä¸­æ¶ˆæ¯çš„ç›‘å¬å™¨ä¸­çš„`consumeMessage`æ–¹æ³•ä¸­

###### 							-5.1. è·å–ç¬¬ä¸€ä¸ªæ¶ˆæ¯ `MessageExt msg = msgs.get(0);` 

###### 						 								-5.2. è·å–åˆ°`String userMomentStr = msg.getbody();`

###### 						 								-5.3. æŠŠ`userMomentStr` æ¢å¤æˆ åŠ¨æ€å¯¹è±¡`userMoment` 

###### 						 								-5.4. é€šè¿‡`userMoment.getUserId` è·å– å‘é€è¯¥åŠ¨æ€äººçš„`userId`

###### 						 								-5.5. é€šè¿‡ä¸€ä¸ªæ–¹æ³•è·å– è¿™ä¸ªäººçš„æ‰€æœ‰ç²‰ä¸  `List<userFans> list åˆ—è¡¨`

###### 						 								-5.6. é€šè¿‡éå† ç²‰ä¸åˆ—è¡¨ `List<userFans> list`  

###### 																		-è·å–æ¯ä¸€ä¸ªç²‰ä¸çš„idå· ä½œä¸º redis çš„`key`  

###### 																		-æŠŠå‘é€çš„åŠ¨æ€ `userMoment`ä½œä¸º redis çš„`value` å­˜åˆ° Redisä¸­ 

###### 														-5.7. æœ€åè¿”å›æ¶ˆæ¯æ¶ˆè´¹æˆåŠŸä¿¡æ¯ `ConsumeConcurrentlyStatus.CONSUME_SUCCESS;`  

> ###### 6.å½“ç”¨æˆ·ç‚¹å‡»åŠ¨æ€åŠŸèƒ½çš„æ—¶å€™ èµ°ä¸€ä¸ªæŸ¥è¯¢è¯·æ±‚ 

###### 													 -é€šè¿‡äº‹å…ˆå®šä¹‰å¥½çš„ä¸€ä¸ªsupportç±» éªŒè¯token ç„¶åè·å–userId ç„¶åå†å» redisä¸­è·å– å¯¹åº”çš„value å³ä¸ºåŠ¨æ€å†…å®¹

